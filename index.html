<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>???</title>
    
    <style>
        * {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            display: flex;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            background-color: #d4ff8f;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            min-width: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 10;
        }

        #controls div {
            display: grid;
            grid-template-columns: 50px 50px 50px;
            gap: 10px;
        }

        #controls button {
            width: 100%;
            height: 40px;
            background-color: white;
            border: 1px solid lightgray;
            box-shadow: 3px 5px 0px 0px rgba(0, 0, 0, 0.75);
            cursor: pointer;
            outline: none;
            font-size: 1.2rem;
        }

        #controls button:active {
            box-shadow: 1px 2px 0px 0px rgba(0, 0, 0, 0.75);
            transform: translateY(2px);
        }

        #controls button:first-of-type {
            grid-column: 1/-1;
        }

        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2em;
            color: white;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #start-message {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.5);
            z-index: 30;
        }

        #start-message > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 50%, #ffa5a5 100%);
            padding: 40px;
            border: 4px solid #e63946;
            border-radius: 20px;
            max-width: 80%;
            text-align: center;
        }

        #start-message h1 {
            margin-top: 0;
            color: #c1121f;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        #start-message p {
            color: #333;
            font-size: 0.7em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        #character-select {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .character-option {
            background-color: white;
            border: 3px solid #e63946;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .character-option:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(230,57,70,0.4);
        }

        .character-option.selected {
            background: linear-gradient(135deg, #dc2f02 0%, #e85d04 100%);
            border-color: #fff;
            color: white;
        }

        .character-emoji {
            font-size: 2em;
        }

        .character-name {
            font-size: 0.5em;
            font-weight: bold;
        }

        #start-message button {
            background-color: #e63946;
            color: white;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 0.8em;
            cursor: pointer;
            border: none;
            box-shadow: 4px 4px 0px 0px #c1121f;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media screen and (max-width: 768px) {
            #character-select {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        #result-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            background-color: rgba(0,0,0,0.4);
            z-index: 20;
        }

        #result {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #dc2f02 0%, #e85d04 100%);
            padding: 40px;
            border: 4px solid #fff;
            border-radius: 20px;
            max-width: 80%;
            text-align: center;
        }

        #result h1 { 
            margin-top: 0; 
            color: white;
            font-size: 1.8em;
        }

        #result .anniversary-message {
            color: #fff5e6;
            font-size: 0.6em;
            line-height: 1.8;
            margin: 20px 0;
            background-color: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
        }

        #result .score-line {
            color: white;
            font-size: 0.8em;
            margin: 10px 0;
        }

        #result button {
            background-color: #9d0208;
            color: white;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 1em;
            cursor: pointer;
            border: none;
            box-shadow: 4px 4px 0px 0px #6a040f;
            margin-top: 20px;
        }

        #youtube, #youtube-card { display: none; }

        @media screen and (max-width: 768px) {
            .left-sidebar, 
            .youtube-container, 
            iframe[src*="youtube.com"] {
                display: none !important;
            }
            #start-message h1 {
                font-size: 1.2em;
            }
            #start-message p {
                font-size: 0.6em;
            }
        }
        
    </style>
</head>
<body>

<canvas class="game"></canvas>

<div id="score">0</div>

<div id="start-message">
    <div>
        <h1>Special Challenge!</h1>
        <p>Choose your character! (Fr just recolorings lol)</p>
        <div id="character-select">
            <div class="character-option selected" data-character="chicken">
                <div class="character-emoji">üêî</div>
                <div class="character-name">CHICKEN</div>
            </div>
            <div class="character-option" data-character="tiger">
                <div class="character-emoji">üêØ</div>
                <div class="character-name">TIGER</div>
            </div>
            <div class="character-option" data-character="bat">
                <div class="character-emoji">ü¶á</div>
                <div class="character-name">BAT</div>
            </div>
            <div class="character-option" data-character="fox">
                <div class="character-emoji">ü¶ä</div>
                <div class="character-name">FOX</div>
            </div>
        </div>
        <p style="font-size: 0.6em;">See how far you can get...<br>Die to reveal a surprise!</p>
        <button id="start-game">START GAME</button>
    </div>
</div>

<div id="controls">
    <div>
        <button id="forward">‚ñ≤</button>
        <button id="left">‚óÄ</button>
        <button id="backward">‚ñº</button>
        <button id="right">‚ñ∂</button>
    </div>
</div>

<div id="result-container">
    <div id="result">
        <h1>HAPPY ONE MONTH!</h1>
        <div class="anniversary-message">
            One month down, excited to see what's next!<br><br>
            Why Crossy Road you may ask?<br>
            Honestly I don't know but I thought it was a fun idea lol<br><br>
            You made it <span id="final-score">0</span> steps in the game...<br>
            My score is unbeatable tho!
        </div>
        <button id="retry">PLAY AGAIN</button>
    </div>
</div>

<a id="youtube" target="_top" href="https://youtu.be/vNr3_hQ3Bws"></a>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';

    // Constants
    const minTileIndex = -8;
    const maxTileIndex = 8;
    const tilesPerRow = maxTileIndex - minTileIndex + 1;
    const tileSize = 42;

    // Camera Setup
    function Camera() {
        const size = 300;
        const viewRatio = window.innerWidth / window.innerHeight;
        const width = viewRatio < 1 ? size : size * viewRatio;
        const height = viewRatio < 1 ? size / viewRatio : size;

        const camera = new THREE.OrthographicCamera(
            width / -2, width / 2, height / 2, height / -2, 100, 900
        );

        camera.up.set(0, 0, 1);
        camera.position.set(300, -300, 300);
        camera.lookAt(0, 0, 0);
        return camera;
    }

    // Texture Utility
    function Texture(width, height, rects) {
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const context = canvas.getContext("2d");
        context.fillStyle = "#ffffff";
        context.fillRect(0, 0, width, height);
        context.fillStyle = "rgba(0,0,0,0.6)";
        rects.forEach((rect) => {
            context.fillRect(rect.x, rect.y, rect.w, rect.h);
        });
        return new THREE.CanvasTexture(canvas);
    }

    const carFrontTexture = new Texture(40, 80, [{ x: 0, y: 10, w: 30, h: 60 }]);
    const carBackTexture = new Texture(40, 80, [{ x: 10, y: 10, w: 30, h: 60 }]);
    const carRightSideTexture = new Texture(110, 40, [{ x: 10, y: 0, w: 50, h: 30 }, { x: 70, y: 0, w: 30, h: 30 }]);
    const carLeftSideTexture = new Texture(110, 40, [{ x: 10, y: 10, w: 50, h: 30 }, { x: 70, y: 10, w: 30, h: 30 }]);
    const truckFrontTexture = new Texture(30, 30, [{ x: 5, y: 0, w: 10, h: 30 }]);
    const truckRightSideTexture = new Texture(25, 30, [{ x: 15, y: 5, w: 10, h: 10 }]);
    const truckLeftSideTexture = new Texture(25, 30, [{ x: 15, y: 15, w: 10, h: 10 }]);

    function Wheel(x) {
        const wheel = new THREE.Mesh(
            new THREE.BoxGeometry(12, 33, 12),
            new THREE.MeshLambertMaterial({ color: 0x333333, flatShading: true })
        );
        wheel.position.x = x;
        wheel.position.z = 6;
        return wheel;
    }

    function Car(initialTileIndex, direction, color) {
        const car = new THREE.Group();
        car.position.x = initialTileIndex * tileSize;
        if (!direction) car.rotation.z = Math.PI;

        const main = new THREE.Mesh(
            new THREE.BoxGeometry(60, 30, 15),
            new THREE.MeshLambertMaterial({ color, flatShading: true })
        );
        main.position.z = 12;
        main.castShadow = true;
        main.receiveShadow = true;
        car.add(main);

        const cabin = new THREE.Mesh(new THREE.BoxGeometry(33, 24, 12), [
            new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true, map: carBackTexture }),
            new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true, map: carFrontTexture }),
            new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true, map: carRightSideTexture }),
            new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true, map: carLeftSideTexture }),
            new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true }),
            new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true }),
        ]);
        cabin.position.x = -6;
        cabin.position.z = 25.5;
        cabin.castShadow = true;
        cabin.receiveShadow = true;
        car.add(cabin);

        car.add(Wheel(18));
        car.add(Wheel(-18));
        return car;
    }

    function Truck(initialTileIndex, direction, color) {
        const truck = new THREE.Group();
        truck.position.x = initialTileIndex * tileSize;
        if (!direction) truck.rotation.z = Math.PI;

        const cargo = new THREE.Mesh(
            new THREE.BoxGeometry(70, 35, 35),
            new THREE.MeshLambertMaterial({ color: 0xb4c6fc, flatShading: true })
        );
        cargo.position.x = -15;
        cargo.position.z = 25;
        cargo.castShadow = true;
        cargo.receiveShadow = true;
        truck.add(cargo);

        const cabin = new THREE.Mesh(new THREE.BoxGeometry(30, 30, 30), [
            new THREE.MeshLambertMaterial({ color, flatShading: true, map: truckFrontTexture }),
            new THREE.MeshLambertMaterial({ color, flatShading: true }),
            new THREE.MeshLambertMaterial({ color, flatShading: true, map: truckLeftSideTexture }),
            new THREE.MeshLambertMaterial({ color, flatShading: true, map: truckRightSideTexture }),
            new THREE.MeshPhongMaterial({ color, flatShading: true }),
            new THREE.MeshPhongMaterial({ color, flatShading: true }),
        ]);
        cabin.position.x = 35;
        cabin.position.z = 20;
        cabin.castShadow = true;
        cabin.receiveShadow = true;
        truck.add(cabin);

        truck.add(Wheel(37));
        truck.add(Wheel(5));
        truck.add(Wheel(-35));
        return truck;
    }

    function Grass(rowIndex) {
        const grass = new THREE.Group();
        grass.position.y = rowIndex * tileSize;
        const createSection = (color) => new THREE.Mesh(
            new THREE.BoxGeometry(tilesPerRow * tileSize, tileSize, 3),
            new THREE.MeshLambertMaterial({ color })
        );
        const middle = createSection(0xd4ff8f);
        middle.receiveShadow = true;
        grass.add(middle);
        return grass;
    }

    function Road(rowIndex) {
        const road = new THREE.Group();
        road.position.y = rowIndex * tileSize;
        const middle = new THREE.Mesh(
            new THREE.PlaneGeometry(tilesPerRow * tileSize, tileSize),
            new THREE.MeshLambertMaterial({ color: 0x454a59 })
        );
        middle.receiveShadow = true;
        road.add(middle);
        return road;
    }

    function Tree(tileIndex, height) {
        const tree = new THREE.Group();
        tree.position.x = tileIndex * tileSize;
        const trunk = new THREE.Mesh(new THREE.BoxGeometry(15, 15, 20), new THREE.MeshLambertMaterial({ color: 0x4d2926 }));
        trunk.position.z = 10;
        tree.add(trunk);
        const crown = new THREE.Mesh(new THREE.BoxGeometry(30, 30, height), new THREE.MeshLambertMaterial({ color: 0x7aa21d }));
        crown.position.z = height / 2 + 20;
        crown.castShadow = true;
        tree.add(crown);
        return tree;
    }

    // Game Logic Globals
    let metadata = [];
    const map = new THREE.Group();
    const position = { currentRow: 0, currentTile: 0 };
    const movesQueue = [];
    const clock = new THREE.Clock();
    const moveClock = new THREE.Clock(false);
    let gameActive = true;
    let gameStarted = false;
    let selectedCharacter = 'chicken';

    const characterColors = {
        chicken: { body: 0xffffff, accent: 0xf0619a },
        tiger: { body: 0xff8c00, accent: 0x000000 },
        bat: { body: 0x4a4a4a, accent: 0x8b008b },
        fox: { body: 0xff4500, accent: 0xffffff }
    };

    function Player() {
        const player = new THREE.Group();
        const colors = characterColors[selectedCharacter];
        
        const body = new THREE.Mesh(
            new THREE.BoxGeometry(15, 15, 20), 
            new THREE.MeshLambertMaterial({ color: colors.body })
        );
        body.position.z = 10;
        body.castShadow = true;
        player.add(body);
        
        const cap = new THREE.Mesh(
            new THREE.BoxGeometry(2, 4, 2), 
            new THREE.MeshLambertMaterial({ color: colors.accent })
        );
        cap.position.z = 21;
        player.add(cap);
        
        const container = new THREE.Group();
        container.add(player);
        return container;
    }

    let player = Player();

    function addRows() {
        const amount = 20;
        const startIndex = metadata.length;
        for (let i = 0; i < amount; i++) {
            const rowData = generateRow();
            metadata.push(rowData);
            const rowIndex = startIndex + i + 1;
            let row;
            if (rowData.type === "forest") {
                row = Grass(rowIndex);
                rowData.trees.forEach(t => row.add(Tree(t.tileIndex, t.height)));
            } else {
                row = Road(rowIndex);
                rowData.vehicles.forEach(v => {
                    const vehicle = rowData.type === "car" ? Car(v.initialTileIndex, rowData.direction, v.color) : Truck(v.initialTileIndex, rowData.direction, v.color);
                    v.ref = vehicle;
                    row.add(vehicle);
                });
            }
            map.add(row);
        }
    }

    function generateRow() {
        const types = ["car", "truck", "forest"];
        const type = types[Math.floor(Math.random() * types.length)];
        if (type === "car") return generateVehicleRow("car", 3);
        if (type === "truck") return generateVehicleRow("truck", 2);
        return generateForestRow();
    }

    function generateVehicleRow(type, count) {
        const direction = Math.random() > 0.5;
        const speed = 100 + Math.random() * 100;
        const vehicles = Array.from({ length: count }, () => ({
            initialTileIndex: THREE.MathUtils.randInt(minTileIndex, maxTileIndex),
            color: [0xa52523, 0xbdb638, 0x78b14b][Math.floor(Math.random() * 3)]
        }));
        return { type, direction, speed, vehicles };
    }

    function generateForestRow() {
        const trees = Array.from({ length: 4 }, () => ({
            tileIndex: THREE.MathUtils.randInt(minTileIndex, maxTileIndex),
            height: [20, 45, 60][Math.floor(Math.random() * 3)]
        }));
        return { type: "forest", trees };
    }

    function queueMove(direction) {
        if(!gameActive || !gameStarted) return;
        const finalPosition = [...movesQueue, direction].reduce((pos, dir) => {
            if (dir === "forward") pos.row++;
            if (dir === "backward") pos.row--;
            if (dir === "left") pos.tile--;
            if (dir === "right") pos.tile++;
            return pos;
        }, { row: position.currentRow, tile: position.currentTile });

        if (finalPosition.row < 0 || finalPosition.tile < minTileIndex || finalPosition.tile > maxTileIndex) return;
        const rowMeta = metadata[finalPosition.row - 1];
        if (rowMeta?.type === "forest" && rowMeta.trees.some(t => t.tileIndex === finalPosition.tile)) return;

        movesQueue.push(direction);
    }

    function stepCompleted() {
        const dir = movesQueue.shift();
        if (dir === "forward") position.currentRow++;
        if (dir === "backward") position.currentRow--;
        if (dir === "left") position.currentTile--;
        if (dir === "right") position.currentTile++;
        if (position.currentRow > metadata.length - 10) addRows();
        document.getElementById("score").innerText = position.currentRow;
    }

    function hitTest() {
        const row = metadata[position.currentRow - 1];
        if (!row || row.type === "forest") return;
        const playerBox = new THREE.Box3().setFromObject(player);
        row.vehicles.forEach(v => {
            if (v.ref && playerBox.intersectsBox(new THREE.Box3().setFromObject(v.ref))) {
                gameActive = false;
                document.getElementById("result-container").style.visibility = "visible";
                document.getElementById("final-score").innerText = position.currentRow;
            }
        });
    }

    function animate() {
        const delta = clock.getDelta();
        
        // Vehicle animation
        metadata.forEach(row => {
            if (row.type === "car" || row.type === "truck") {
                row.vehicles.forEach(v => {
                    if (!v.ref) return;
                    if (row.direction) {
                        v.ref.position.x += row.speed * delta;
                        if (v.ref.position.x > (maxTileIndex + 2) * tileSize) v.ref.position.x = (minTileIndex - 2) * tileSize;
                    } else {
                        v.ref.position.x -= row.speed * delta;
                        if (v.ref.position.x < (minTileIndex - 2) * tileSize) v.ref.position.x = (maxTileIndex + 2) * tileSize;
                    }
                });
            }
        });

        // Player animation
        if (movesQueue.length > 0) {
            if (!moveClock.running) moveClock.start();
            const progress = Math.min(1, moveClock.getElapsedTime() / 0.2);
            
            const startX = position.currentTile * tileSize;
            const startY = position.currentRow * tileSize;
            let endX = startX, endY = startY, endRot = 0;

            if (movesQueue[0] === "left") { endX -= tileSize; endRot = Math.PI / 2; }
            if (movesQueue[0] === "right") { endX += tileSize; endRot = -Math.PI / 2; }
            if (movesQueue[0] === "forward") { endY += tileSize; endRot = 0; }
            if (movesQueue[0] === "backward") { endY -= tileSize; endRot = Math.PI; }

            player.position.x = THREE.MathUtils.lerp(startX, endX, progress);
            player.position.y = THREE.MathUtils.lerp(startY, endY, progress);
            player.children[0].position.z = Math.sin(progress * Math.PI) * 10;
            player.children[0].rotation.z = THREE.MathUtils.lerp(player.children[0].rotation.z, endRot, progress);

            if (progress >= 1) { stepCompleted(); moveClock.stop(); }
        }

        if (gameActive) hitTest();
        renderer.render(scene, camera);
    }

    // Init Scene
    const scene = new THREE.Scene();
    const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector(".game"), antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(-100, -100, 200);
    scene.add(dirLight);

    const camera = Camera();
    scene.add(player);
    scene.add(map);
    player.add(camera);

    function initializeGame() {
        metadata = [];
        map.clear();
        position.currentRow = 0;
        position.currentTile = 0;
        movesQueue.length = 0;
        gameActive = true;
        player.position.set(0,0,0);
        player.children[0].rotation.z = 0;
        
        for (let i = 0; i > -10; i--) map.add(Grass(i));
        addRows();
        
        document.getElementById("score").innerText = "0";
        document.getElementById("result-container").style.visibility = "hidden";
    }

    window.addEventListener("keydown", e => {
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) e.preventDefault();
        if (e.key === "ArrowUp") queueMove("forward");
        if (e.key === "ArrowDown") queueMove("backward");
        if (e.key === "ArrowLeft") queueMove("left");
        if (e.key === "ArrowRight") queueMove("right");
    });

    document.getElementById("forward").onclick = () => queueMove("forward");
    document.getElementById("backward").onclick = () => queueMove("backward");
    document.getElementById("left").onclick = () => queueMove("left");
    document.getElementById("right").onclick = () => queueMove("right");
    document.getElementById("retry").onclick = () => initializeGame();
    
    // Character selection
    document.querySelectorAll('.character-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.character-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            selectedCharacter = option.dataset.character;
        });
    });
    
    document.getElementById("start-game").onclick = () => {
        document.getElementById("start-message").style.display = "none";
        gameStarted = true;
        
        // Recreate player with selected character
        scene.remove(player);
        player = Player();
        scene.add(player);
        player.add(camera);
        player.position.set(0, 0, 0);
    };

    initializeGame();
    renderer.setAnimationLoop(animate);

    window.onresize = () => {
        const cam = Camera();
        camera.left = cam.left; camera.right = cam.right; camera.top = cam.top; camera.bottom = cam.bottom;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    };
</script>
</body>
</html>